#!/bin/sh

[ "$CONSUL" = "no" ] && sv stop "$PWD"

GWDEV="$(ip route list 0/0 | awk '{print $NF}')"

ADVERTISE="${ADVERTISE:-$(ip -f inet -o a s | awk -F " +|/" "\$2 != \"lo\" && \$2 != \"$GWDEV\" {print \$4; exit(0)}")}"

# write our config file
cat << dog > /consul.json
{
	"bootstrap_expect": $CONSUL_BOOTSTRAP_EXPECT,
	"datacenter": "$CONSUL_DATACENTER",
	"domain": "$CONSUL_DOMAIN",
	"server": true,
	"data_dir": "/consul",
	"client_addr": "0.0.0.0",
	"advertise_addr": "$ADVERTISE",
	"retry_interval": "10s",
dog
if [ -n "$CONSUL_JOIN" ]; then
	echo "	\"retry_join\": [\"$(echo "$CONSUL_JOIN" | sed -e 's/ /","/g')\"]," >> /consul.json
fi
if [ -n "$CONSUL_RECURSORS" ]; then
	echo "	\"recursors\": [\"$(echo "$CONSUL_RECURSORS" | sed -e 's/ /","/g')\"]," >> /consul.json
fi
if [ -n "$CONSUL_WAN" ]; then
	echo "	\"retry_join_wan\": [\"$(echo "$CONSUL_WAN" | sed -e 's/ /","/g')\"]," >> /consul.json
fi
cat << dog >> /consul.json
	"ports": {
		"dns": $CONSUL_PORT_DNS
	},
	"ui_dir": "/webui"
}
dog

# slip our config file into our cmd line
while [ "$RETRY" -gt 0 ]; do
	echo "Starting consul $RETRY left"
	/bin/consul agent -config-file /consul.json ${CONSUL_ARGS:-}
	sleep "$TIMEOUT"
	RETRY=$(( RETRY - 1 ))
done

cat /consul.json

killall runsvdir

